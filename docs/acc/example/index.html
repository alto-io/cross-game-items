<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick-theme.min.css"/>
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>

  <h2>Alto Cryptogame Challenge Example</h2>
  <p class= "blue" id="mmwarning"></p>
  <h3>User Wallet Address</h3>
  <p id="useradd">Loading...</p>
  <h3>Item Definitions</h3>

  <section id="features" class="item-card">

    <div class="loader"></div>

    <div class="content">


      <div class="item-definitions item-featured">
      </div>
      <div class="item-definitions-nav item-card">
      </div>
    </div>

  </section>


  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

  <script>
  window.onload = function()
  {
    var userWalletID;
    // Ropsten = 3, Kovan = 42, Rinkeby = 4
    var networkID = "4";
    var accWalletID = "0x1331B779A3D4Bd3f7E605e8c8A7D4Edcf692Fd6b";
    var itemDefinitionObjects;

    // initialize slick-carousel
    $('.item-definitions').slick({
     slidesToShow: 1,
     slidesToScroll: 1,
     arrows: false,
     fade: true,
     asNavFor: '.item-definitions-nav'
   });
   $('.item-definitions-nav').slick({
     slidesToShow: 5,
     slidesToScroll: 5,
     asNavFor: '.item-definitions',
     dots: false,
     centerMode: true,
     focusOnSelect: true
   });


    if (typeof web3 !== 'undefined') {
      web3Provider = web3.currentProvider;
    } else {
      document.getElementById('mmwarning').textContent="Metamask not installed. Install the metamask chrome extension.";
      $('#mmwarning').effect("pulsate", 1000);

    }

    web3 = new Web3(web3Provider);

    // Get user account ID
    userWalletID = web3.eth.accounts[0];
    if (userWalletID)
      document.getElementById('useradd').textContent=userWalletID;

    // detect metamask account changes
    web3.currentProvider.publicConfigStore.on('update', function(data){
      var addressText = document.getElementById('useradd');
      var oldText = addressText.textContent;

      if (data.selectedAddress) {
        // Get user account ID
        userWalletID = data.selectedAddress;
        addressText.textContent=userWalletID;
      }
      else {
        userWalletID = null;
        addressText.textContent="Metamask/web3 provider is locked, please login";
      }

      if (addressText.textContent != oldText)
        $('#useradd').effect("highlight", 1000);
    });

    // wrap the ERC721 method `tokenURI()` in a promise so we can wait for it
    var getTokenURI = (tokenId) => new Promise((resolve, reject) => {
      ownershipInstance.tokenURI(tokenId, (err, result) => {
        if (err) return reject(err);

        return resolve(result);
      });
    });

    // display the selected item defintion
    var displayItemDefinition = async (index) => {

        // don't load anymore if item already loaded

        if ($('#itemdef' + index).find(".itemtext").length > 0) {
          $('.loader').hide();
          return;
        }

        $('#itemdef' + index).find("p").replaceWith('<p class="itemtext">itemID: ' + index + '</p>');

        // get token URI which contains item json metadata
        let uri = await getTokenURI(itemDefinitionObjects[1][index]);

        $('#itemdef' + index).find("h3").append('<p class="itemtext">tokenURI: ' + uri + '</p>');

        $.get(uri, function(data) {
          Object.keys(data).forEach(function (key) {
            $('#itemdef' + index).find("h3").append('<p class="itemtext">' + key + ': ' + data[key] + '</p>');

            if (key == 'image')
            {
              $('#itemdef' + index).find("h3").append('<img src="' + data[key] + '"></img>');
            }

          });

          $('.loader').hide();

        });
    }

    // retrieve tokenURI in a promise so we can await
    var getTokenURI = (tokenID) => new Promise((resolve, reject) => {
      ownershipInstance.tokenURI(tokenID, (err, result) => {
        if (err) return reject(err);
        return resolve(result);
      });
    });

    // retrieve itemDefinitions in a promise so we can await
    var getItemDefinitions = (walletID) => new Promise((resolve, reject) => {
      // get the item definitions
      ownershipInstance.itemDefsOf(walletID, async (err, result) => {
        if (err) return reject(err);
        return resolve(result);
      });
    });



    // start interacting with the smart contract
    $.getJSON('/contracts/Ownership.json', async function(data) {
      ownershipInstance = web3.eth.contract(data.abi).at(data.networks[networkID].address);


      itemDefinitionObjects = await getItemDefinitions(accWalletID);

      // refresh item definition Display
      for (var i = 0; i < itemDefinitionObjects[0].length; i++) {
        $('.item-definitions').slick('slickAdd','<div id="itemdef' + i +'"><h3><p> ... </p></h3></div>');
        $('.item-definitions-nav').slick('slickAdd','<div id="itemdefnav' + i +'"><h3>' + i + '</h3></div>');

        // show item info on click
        $('#itemdefnav' + i).bind("click", function() {
          $('.loader').show();
          displayItemDefinition($ (this).text());
        });
      }

      // display the first item
      displayItemDefinition(0);


      // get items owned by the web3 (metamask) user
      ownershipInstance.itemsOf(userWalletID, async (err, items) => {
        console.log("items owned by " + userWalletID)
        console.log(items);
      });
    });

/*
    $.getJSON('/contracts/ItemManager.json', function(data) {
      // Get the necessary contract artifact json file and instantiate it with truffle-contract
      itemManagerInstance = web3.eth.contract(data.abi).at(data.networks[networkID].address);
    });
*/


  }
  </script>


</body>
</html>
