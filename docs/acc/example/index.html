<!DOCTYPE html>
<html>
<body>
  <h2>Alto Cryptogame Challenge Example</h2>
  <p id="mmwarning"></p>
  <h3>User Wallet Address</h3>
  <p id="useradd">Loading...</p>
  <h3>Item Definitions</h3>
  <p id="itemdef">0</p>
  <h3>Sim Balance</h3>
  <p id="itemsowned">0</p>


  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="js/web3.min.js"></script>

  <script>
  window.onload = function()
  {
    var userWalletID;
    // Ropsten = 3, Kovan = 42, Rinkeby = 4
    var networkID = "4";
    var accWalletID = "0x1331B779A3D4Bd3f7E605e8c8A7D4Edcf692Fd6b";

    if (typeof web3 !== 'undefined') {
      web3Provider = web3.currentProvider;
    } else {
      document.getElementById('mmwarning').textContent="Metamask not installed. Install the metamask chrome extension.";
      $('#mmwarning').effect("pulsate", 5000);

    }

    web3 = new Web3(web3Provider);

    // Get user account ID
    userWalletID = web3.eth.accounts[0];
    if (userWalletID)
      document.getElementById('useradd').textContent=userWalletID;

    // detect metamask account changes
    web3.currentProvider.publicConfigStore.on('update', function(data){
      var addressText = document.getElementById('useradd');
      var oldText = addressText.textContent;

      if (data.selectedAddress) {
        // Get user account ID
        userWalletID = data.selectedAddress;
        addressText.textContent=userWalletID;
      }
      else {
        userWalletID = null;
        addressText.textContent="Metamask/web3 provider is locked, please login";
      }

      if (addressText.textContent != oldText)
        $('#useradd').effect("highlight", 1000);
    });

    $.getJSON('/contracts/Ownership.json', function(data) {
      ownershipInstance = web3.eth.contract(data.abi).at(data.networks[networkID].address);

      ownershipInstance.itemDefsOf(accWalletID, async (err, itemDefs) => {
        console.log("items defined at " + accWalletID)
        console.log(itemDefs);

        // wrap the ERC721 method `tokenURI()` in a promise so we can wait for it
        var getTokenURI = (tokenId) => new Promise((resolve, reject) => {
          ownershipInstance.tokenURI(tokenId, (err, result) => {
            if (err) return reject(err);

            return resolve(result);
          });
        });

        // get the ERC721 Metadata URI and then fetch the metadata
        // for (var i = 0; i < itemDefs[0].length; i++) {
        for (var i = 0; i < 1; i++) {

          try {

            // we are fetching the DNA defined by `accWallet`
            let uri = await getTokenURI(itemDefs[1][i]);
            console.log(uri);

            $.get(uri, function(data) {
              console.log(data);
            });
          } catch (e) {
            console.log(e);
          }
        }
      });

      // get items owned by the web3 (metamask) user
      ownershipInstance.itemsOf(userWalletID, async (err, items) => {
        console.log("items owned by " + userWalletID)
        console.log(items);
      });
    });

/*
    $.getJSON('/contracts/ItemManager.json', function(data) {
      // Get the necessary contract artifact json file and instantiate it with truffle-contract
      itemManagerInstance = web3.eth.contract(data.abi).at(data.networks[networkID].address);
    });
*/


  }
  </script>


</body>
</html>
